# QualityFoundry - Policy Configuration
# Version 1.0 - L1 Policy Layer
# 
# This file defines the gate rules for orchestration decisions.
# Modify this file to change gate behavior without code changes.

version: "1.0"

# High-risk keywords that trigger HITL (Human-In-The-Loop)
# Any of these words in the nl_input will trigger NEED_HITL decision
high_risk_keywords:
  - delete
  - drop
  - truncate
  - remove
  - destroy
  - prod
  - production
  - master
  - main
  - release
  - deploy
  - rollback
  - migration
  - schema
  - database
  - db

# High-risk patterns (regex) that trigger HITL
# Matched against the full nl_input using case-insensitive search
high_risk_patterns:
  - "\\bprod\\b"
  - "\\bproduction\\b"
  - "\\bdelete\\s+from\\b"
  - "\\bdrop\\s+table\\b"
  - "\\btruncate\\b"
  - "\\brm\\s+-rf\\b"
  - "\\bsudo\\b"

# JUnit pass rule: thresholds for PASS decision
# If failures <= max_failures AND errors <= max_errors, decision is PASS
junit_pass_rule:
  max_failures: 0
  max_errors: 0

# Fallback rule when no JUnit XML is available
# If require_all_tools_success is true, all tool calls must succeed for PASS
fallback_rule:
  require_all_tools_success: true

# Cost governance (future expansion)
cost_governance:
  timeout_s: 300
  max_retries: 3

# Tools policy: allowlist of permitted tools
# Empty list = allow all registered tools (default open)
tools:
  allowlist:
    - run_playwright
    - run_pytest
    - fetch_logs

# Sandbox configuration (L3 执行层隔离)
# Controls subprocess execution boundaries for security
sandbox:
  enabled: true
  # mode: subprocess (default, cross-platform) | container (Linux CI, stronger isolation)
  mode: subprocess
  timeout_s: 300
  memory_limit_mb: 512
  allowed_paths:
    - "tests/"
    - "test/"
    - "artifacts/"
  env_whitelist:
    # Core system (Unix/Mac)
    - "PATH"
    - "HOME"
    - "USER"
    - "SHELL"
    - "TMPDIR"
    - "TEMP"
    - "TMP"
    # Windows system (required for pytest/subprocess on Windows CI)
    - "SYSTEMROOT"
    - "WINDIR"
    - "COMSPEC"
    - "PATHEXT"
    - "USERPROFILE"
    - "HOMEDRIVE"
    - "HOMEPATH"
    - "APPDATA"
    - "LOCALAPPDATA"
    - "PROGRAMFILES"
    - "PROGRAMFILES(X86)"
    - "COMMONPROGRAMFILES"
    - "SYSTEMDRIVE"
    - "NUMBER_OF_PROCESSORS"
    - "PROCESSOR_ARCHITECTURE"
    - "OS"
    - "USERNAME"
    # Python
    - "PYTHONPATH"
    - "PYTHONDONTWRITEBYTECODE"
    - "PYTHONUNBUFFERED"
    - "VIRTUAL_ENV"
    # Locale
    - "LANG"
    - "LC_*"
    # CI/CD
    - "CI"
    - "GITHUB_*"
    - "RUNNER_*"
    - "ACTIONS_*"
    # QualityFoundry
    - "QF_*"
  # Container settings (used when mode=container)
  # Env override: QF_CONTAINER_IMAGE
  container:
    image: "python:3.11-slim"
    network_disabled: true

# AI Review Configuration (Phase 2)
# 多模型评审系统配置
ai_review:
  enabled: false  # 默认禁用，需显式开启
  models:
    - name: "gpt-4"
      provider: "openai"
      weight: 1.0
      temperature: 0.0
    - name: "claude-3-sonnet"
      provider: "anthropic"
      weight: 1.0
      temperature: 0.0
  strategy: "majority_vote"  # majority_vote | weighted_ensemble | cascade
  thresholds:
    pass_confidence: 0.8      # 通过的最小置信度
    hitl_confidence: 0.5      # 低于此值触发人工介入
  dimensions:
    - "correctness"
    - "safety"
  max_retries: 2
  timeout_seconds: 30
