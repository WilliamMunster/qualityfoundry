name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    name: unit-tests
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install project (editable) + dev tools
        shell: pwsh
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e ".\backend[dev]"

      - name: Lint (ruff)
        shell: pwsh
        run: |
          ruff check .

      - name: Playwright Status Check
        shell: pwsh
        run: |
          if ($env:PLAYWRIGHT_E2E -eq "1") {
            Write-Host "✅ PLAYWRIGHT_E2E is enabled"
          } else {
            Write-Host "⏭️ PLAYWRIGHT_E2E is disabled (Expected in CI)"
          }

      - name: Unit tests (pytest)
        shell: pwsh
        run: |
          cd backend
          pytest -q --tb=short
          if ($LASTEXITCODE -eq 5) { exit 0 }
          exit $LASTEXITCODE

  # Smoke Fast - Required check
  smoke-fast:
    name: smoke-fast
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e "./backend[dev]"

      - name: Run smoke_fast
        run: |
          cd backend
          pytest -m smoke_fast --tb=short

  # MCP Write Security - required check for L4 write capability
  mcp-security:
    name: mcp-security
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e "./backend[dev]"

      - name: MCP write security tests
        run: |
          cd backend
          pytest tests/test_mcp_write_security.py tests/test_mcp_server_smoke.py -v --tb=short

  # Dashboard Contracts - required check for L5 data accuracy
  dashboard-contracts:
    name: dashboard-contracts
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e "./backend[dev]"

      - name: Dashboard contract tests
        run: |
          cd backend
          pytest tests/test_api_contract_dashboard_summary.py -v --tb=short

  # Regression smoke - run golden dataset evals (optional, non-blocking)
  regression-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [unit-tests]
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e "./backend[dev]"

      - name: Run regression tests
        run: |
          cd backend
          python -m qualityfoundry.evals \
            --dataset app/qualityfoundry/governance/golden/dataset.yaml \
            --output /tmp/evals_results \
            --baseline-id ci-baseline \
            --fail-on-regression || true

