name: E2E Smoke

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


jobs:
  e2e-smoke:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend (editable) + Playwright
        shell: pwsh
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e .\backend
          python -m pip install playwright
          python -m playwright install chromium

      - name: Debug backend code origin (generator)
        shell: pwsh
        run: |
          python -c "import qualityfoundry, inspect; import qualityfoundry.services.generation.generator as g; print('qualityfoundry.__file__=', getattr(qualityfoundry,'__file__',None)); print('generator_file=', g.__file__); src=inspect.getsource(g.generate_bundle).splitlines(); print('generate_bundle_head='); print('\n'.join(src[:60]))"
          python -m pip show qualityfoundry || echo "pip show qualityfoundry: not found"

      - name: Debug generator origin
        shell: pwsh
        run: |
          $env:PYTHONPATH = "${{ github.workspace }}\backend\app"
          python -c "import qualityfoundry.services.generation.generator as g, inspect; print('generator_file=', g.__file__); print('has_smoke_branch=', '_extract_url_and_expect' in inspect.getsource(g))"


      - name: Start API server
        shell: pwsh
        run: |
          # 强制优先加载仓库源码（避免被 site-packages 里的旧版本覆盖）
          $env:PYTHONPATH = "${{ github.workspace }}\backend\app"

          # 启动 uvicorn（不使用 --reload，CI 更稳定）
          $p = Start-Process -FilePath python -ArgumentList @(
            "-m","uvicorn","qualityfoundry.main:app",
            "--host","127.0.0.1","--port","8000"
          ) -PassThru

          # 等待服务就绪（最多等 30 秒）
          $ready = $false
          for ($i=0; $i -lt 30; $i++) {
            try {
              Invoke-RestMethod -Uri "http://127.0.0.1:8000/healthz" -Method GET -TimeoutSec 2 | Out-Null
              $ready = $true
              break
            } catch {
              Start-Sleep -Seconds 1
            }
          }

          if (-not $ready) {
            Write-Host "服务未能在 30 秒内就绪，终止进程：$($p.Id)"
            Stop-Process -Id $p.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }

          Set-Content -Path .\server.pid -Value $p.Id -Encoding ascii
          Write-Host "服务已启动，PID=$($p.Id)"

      - name: Run smoke (execute_bundle)
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process Bypass
          .\scripts\smoke_execute_bundle.ps1 -Base "http://127.0.0.1:8000" -TimeoutSec 180

      - name: Run smoke (scripts/smoke_bundle.ps1)
        id: smoke
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process Bypass
          .\scripts\smoke_bundle.ps1 -Base "http://127.0.0.1:8000"

      - name: Stop API server
        if: always()
        shell: pwsh
        run: |
          if (Test-Path .\server.pid) {
            $serverPid = Get-Content .\server.pid
            Write-Host "停止服务 PID=$serverPid"
            Stop-Process -Id $serverPid -Force -ErrorAction SilentlyContinue
          }

      - name: Upload artifacts (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: artifacts/**
          if-no-files-found: ignore