name: E2E Smoke

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-smoke:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend (editable) + Playwright
        shell: pwsh
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e .\backend
          python -m pip install playwright
          python -m playwright install chromium

      # ----------------------------
      # Debug：确认 CI 使用的是仓库里的 generator，而不是其它路径/缓存
      # ----------------------------
      - name: Debug backend code origin (generator)
        shell: pwsh
        run: |
          python -c "import qualityfoundry, inspect; import qualityfoundry.services.generation.generator as g; print('qualityfoundry.__file__=', getattr(qualityfoundry,'__file__',None)); print('generator_file=', g.__file__); src=inspect.getsource(g.generate_bundle).splitlines(); print('generate_bundle_head='); print('\n'.join(src[:60]))"
          python -m pip show qualityfoundry || echo "pip show qualityfoundry: not found"

      - name: Debug generator origin
        shell: pwsh
        run: |
          $env:PYTHONPATH = "${{ github.workspace }}\backend\app"
          python -c "import qualityfoundry.services.generation.generator as g, inspect; print('generator_file=', g.__file__); print('has_smoke_branch=', '_extract_url_and_expect' in inspect.getsource(g))"

      # ----------------------------
      # 启动 API：自动选择可用端口（8000 优先），并写入 .qf_port/.server_pid
      # ----------------------------
      - name: Start API server (auto port)
        id: start_api
        shell: pwsh
        run: |
          function Test-PortFree([int]$port) {
            try {
              Get-NetTCPConnection -LocalAddress 127.0.0.1 -LocalPort $port -State Listen -ErrorAction Stop | Out-Null
              return $false
            } catch { return $true }
          }

          # 1) 找可用端口：8000 起，最多尝试 30 个
          $port = 8000
          $found = $false
          for ($i=0; $i -lt 30; $i++) {
            if (Test-PortFree $port) { $found = $true; break }
            $port++
          }

          if (-not $found) {
            Write-Host "未找到可用端口（从 8000 起尝试 30 个）"
            exit 1
          }

          Write-Host "Selected port=$port"
          Set-Content -Path .\.qf_port -Value $port -Encoding ascii

          # 2) 启动服务（CI 不建议 --reload）
          $p = Start-Process -FilePath python -ArgumentList @(
            "-m","uvicorn","qualityfoundry.main:app",
            "--host","127.0.0.1","--port",("$port")
          ) -PassThru

          Set-Content -Path .\.server_pid -Value $p.Id -Encoding ascii

          # 3) 等待就绪（最多 45 秒）
          #    NOTE: 当前服务优先支持 /health（本项目 smoke readiness 也是 /health → /healthz → /openapi）
          $health = "http://127.0.0.1:$port/health"
          $ready = $false
          for ($i=0; $i -lt 45; $i++) {
            try {
              Invoke-RestMethod -Uri $health -Method GET -TimeoutSec 2 | Out-Null
              $ready = $true
              break
            } catch {
              Start-Sleep -Seconds 1
            }
          }

          if (-not $ready) {
            Write-Host "服务未能在 45 秒内就绪，终止进程：PID=$($p.Id)"
            Stop-Process -Id $p.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }

          # 4) 输出给后续 step 使用
          "port=$port"     | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "health=$health" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "READY: $health (PID=$($p.Id))"

      # ----------------------------
      # 冒烟 1：execute_bundle（显式传入 start_api 的端口）
      # ----------------------------
      - name: Run smoke execute_bundle
        id: smoke_exec
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process Bypass
          $port = "${{ steps.start_api.outputs.port }}"
          $health = "${{ steps.start_api.outputs.health }}"
          $base = "http://127.0.0.1:$port"
          Write-Host "[E2E] start_api.port=$port"
          Write-Host "[E2E] start_api.health=$health"
          Write-Host "[E2E] smoke_execute_bundle base=$base"
          .\scripts\smoke_execute_bundle.ps1 -Base $base -TimeoutSec 180

      # ----------------------------
      # 冒烟 2：compile_bundle -> execute（显式传入 start_api 的端口）
      # ----------------------------
      - name: Run smoke (scripts/smoke_bundle.ps1)
        id: smoke
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process Bypass
          $port = "${{ steps.start_api.outputs.port }}"
          $health = "${{ steps.start_api.outputs.health }}"
          $base = "http://127.0.0.1:$port"
          Write-Host "[E2E] start_api.port=$port"
          Write-Host "[E2E] start_api.health=$health"
          Write-Host "[E2E] smoke_bundle base=$base"
          .\scripts\smoke_bundle.ps1 -Base $base -TimeoutSec 180

      # ----------------------------
      # 停服：永远执行
      # ----------------------------
      - name: Stop API server
        if: always()
        shell: pwsh
        run: |
          if (Test-Path .\.server_pid) {
            $serverPid = (Get-Content .\.server_pid | Select-Object -First 1).Trim()
            Write-Host "Stopping PID=$serverPid"
            Stop-Process -Id $serverPid -Force -ErrorAction SilentlyContinue
          }

      # ----------------------------
      # 上传产物：固定上传 artifacts + qf port/pid 文件（永远有 path，不再依赖 step outputs）
      # ----------------------------
      - name: Upload artifacts (this run only)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            artifacts
            .qf_port
            .server_pid
          if-no-files-found: ignore
