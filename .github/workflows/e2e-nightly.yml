name: E2E Nightly Tests

on:
  schedule:
    # 每天凌晨 2 点运行 (UTC)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  # E2E 测试账号（从 secrets 读取，不在代码中硬编码）
  E2E_ADMIN_USER: ${{ secrets.E2E_ADMIN_USER }}
  E2E_ADMIN_PASS: ${{ secrets.E2E_ADMIN_PASS }}
  E2E_BASE_URL: http://localhost:5173

jobs:
  e2e-test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ========== 1. 检出代码 ==========
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========== 2. 设置 Python 环境 ==========
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e "./backend[dev]"

      # ========== 3. 设置 Node.js 环境 ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      # ========== 4. 安装 Playwright 浏览器 ==========
      - name: Install Playwright browsers
        run: |
          cd frontend
          npx playwright install chromium
          npx playwright install-deps chromium

      # ========== 5. 启动后端服务 ==========
      - name: Start backend service
        run: |
          cd backend
          # 初始化测试数据库
          python -c "
          from qualityfoundry.database.config import init_db
          from qualityfoundry.core.db import engine
          init_db(engine)
          "
          # 创建测试用户（密码从环境变量读取）
          python -c "
          import os
          from qualityfoundry.database.config import SessionLocal
          from qualityfoundry.database.user_models import User, UserRole
          from qualityfoundry.services.auth_service import AuthService
          
          db = SessionLocal()
          # 如果用户存在则删除重建
          existing = db.query(User).filter(User.username == os.environ['E2E_ADMIN_USER']).first()
          if existing:
              db.delete(existing)
              db.commit()
          
          # 创建新用户
          user = User(
              username=os.environ['E2E_ADMIN_USER'],
              email='e2e@test.com',
              password_hash=AuthService.hash_password(os.environ['E2E_ADMIN_PASS']),
              role=UserRole.ADMIN,
              is_active=True
          )
          db.add(user)
          db.commit()
          print(f'Created test user: {user.username}')
          "
          # 后台启动服务
          uvicorn qualityfoundry.main:app --host 0.0.0.0 --port 8000 &
          echo "Backend PID: $!"
          echo "BACKEND_PID=$!" >> $GITHUB_ENV
          
          # 等待服务就绪
          sleep 3
          curl -s http://localhost:8000/health || (echo "Backend health check failed" && exit 1)
          echo "✅ Backend is ready"

      # ========== 6. 启动前端服务 ==========
      - name: Start frontend service
        run: |
          cd frontend
          # 后台启动开发服务器
          npm run dev &
          echo "FRONTEND_PID=$!" >> $GITHUB_ENV
          
          # 等待服务就绪
          sleep 5
          curl -s http://localhost:5173 || (echo "Frontend health check failed" && exit 1)
          echo "✅ Frontend is ready"

      # ========== 7. 运行 E2E 测试 ==========
      - name: Run Playwright tests
        run: |
          cd frontend
          npx playwright test e2e/ \
            --project=chromium \
            --reporter=list,html \
            --trace=on-first-retry \
            ${{ github.event.inputs.debug == 'true' && '--debug' || '' }}
        env:
          # Playwright 配置
          PLAYWRIGHT_HTML_REPORT: playwright-report
          # 测试超时设置
          PLAYWRIGHT_TIMEOUT: 60000
          # 慢动作模式（调试用）
          PWDEBUG: ${{ github.event.inputs.debug == 'true' && '1' || '' }}

      # ========== 8. 上传测试产物（失败时）==========
      - name: Upload test artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-artifacts-${{ github.run_id }}
          path: |
            frontend/test-results/
            frontend/playwright-report/
          retention-days: 7
          if-no-files-found: warn

      # ========== 9. 上传测试报告（总是）==========
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-${{ github.run_id }}
          path: frontend/playwright-report/
          retention-days: 3

      # ========== 10. 清理服务 ==========
      - name: Cleanup services
        if: always()
        run: |
          echo "Stopping services..."
          kill $BACKEND_PID 2>/dev/null || true
          kill $FRONTEND_PID 2>/dev/null || true
          echo "Cleanup complete"

  # ========== 测试结果通知 ==========
  notify:
    name: Notify test results
    needs: e2e-test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test result
        run: |
          if [ "${{ needs.e2e-test.result }}" == "success" ]; then
            echo "✅ E2E tests passed"
          else
            echo "❌ E2E tests failed"
            # 这里可以添加 Slack/Email 通知
            # curl -X POST $SLACK_WEBHOOK -d '{"text":"E2E tests failed: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
          fi
