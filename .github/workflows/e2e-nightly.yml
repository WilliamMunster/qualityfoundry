name: E2E Nightly Tests

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œ (UTC)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  # E2E æµ‹è¯•è´¦å·ï¼ˆä» secrets è¯»å–ï¼Œä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ï¼‰
  E2E_ADMIN_USER: ${{ secrets.E2E_ADMIN_USER }}
  E2E_ADMIN_PASS: ${{ secrets.E2E_ADMIN_PASS }}
  E2E_BASE_URL: http://localhost:5173

jobs:
  e2e-test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ========== 1. æ£€å‡ºä»£ç  ==========
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========== 2. è®¾ç½® Python ç¯å¢ƒ ==========
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install -e "./backend[dev]"

      # ========== 3. è®¾ç½® Node.js ç¯å¢ƒ ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      # ========== 4. å®‰è£… Playwright æµè§ˆå™¨ ==========
      - name: Install Playwright browsers
        run: |
          cd frontend
          npx playwright install chromium
          npx playwright install-deps chromium

      # ========== 5. å¯åŠ¨åç«¯æœåŠ¡ ==========
      - name: Start backend service
        run: |
          cd backend
          # åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
          python -c "
          from qualityfoundry.database.config import init_db
          from qualityfoundry.core.db import engine
          init_db(engine)
          "
          # åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆå¯†ç ä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
          python -c "
          import os
          from qualityfoundry.database.config import SessionLocal
          from qualityfoundry.database.user_models import User, UserRole
          from qualityfoundry.services.auth_service import AuthService
          
          db = SessionLocal()
          # å¦‚æœç”¨æˆ·å­˜åœ¨åˆ™åˆ é™¤é‡å»º
          existing = db.query(User).filter(User.username == os.environ['E2E_ADMIN_USER']).first()
          if existing:
              db.delete(existing)
              db.commit()
          
          # åˆ›å»ºæ–°ç”¨æˆ·
          user = User(
              username=os.environ['E2E_ADMIN_USER'],
              email='e2e@test.com',
              password_hash=AuthService.hash_password(os.environ['E2E_ADMIN_PASS']),
              role=UserRole.ADMIN,
              is_active=True
          )
          db.add(user)
          db.commit()
          print(f'Created test user: {user.username}')
          "
          # åå°å¯åŠ¨æœåŠ¡
          uvicorn qualityfoundry.main:app --host 0.0.0.0 --port 8000 &
          echo "Backend PID: $!"
          echo "BACKEND_PID=$!" >> $GITHUB_ENV
          
          # ç­‰å¾…æœåŠ¡å°±ç»ª
          sleep 3
          curl -s http://localhost:8000/health || (echo "Backend health check failed" && exit 1)
          echo "âœ… Backend is ready"

      # ========== 6. å¯åŠ¨å‰ç«¯æœåŠ¡ ==========
      - name: Start frontend service
        run: |
          cd frontend
          # åå°å¯åŠ¨å¼€å‘æœåŠ¡å™¨
          npm run dev &
          echo "FRONTEND_PID=$!" >> $GITHUB_ENV
          
          # ç­‰å¾…æœåŠ¡å°±ç»ª
          sleep 5
          curl -s http://localhost:5173 || (echo "Frontend health check failed" && exit 1)
          echo "âœ… Frontend is ready"

      # ========== 7. è¿è¡Œ E2E æµ‹è¯• ==========
      - name: Run Playwright tests
        run: |
          cd frontend
          npx playwright test e2e/ \
            --project=chromium \
            --reporter=list,html \
            --trace=on-first-retry \
            ${{ github.event.inputs.debug == 'true' && '--debug' || '' }}
        env:
          # Playwright é…ç½®
          PLAYWRIGHT_HTML_REPORT: playwright-report
          # æµ‹è¯•è¶…æ—¶è®¾ç½®
          PLAYWRIGHT_TIMEOUT: 60000
          # æ…¢åŠ¨ä½œæ¨¡å¼ï¼ˆè°ƒè¯•ç”¨ï¼‰
          PWDEBUG: ${{ github.event.inputs.debug == 'true' && '1' || '' }}

      # ========== 8. ä¸Šä¼ æµ‹è¯•äº§ç‰©ï¼ˆå¤±è´¥æ—¶ï¼‰==========
      - name: Upload test artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-artifacts-${{ github.run_id }}
          path: |
            frontend/test-results/
            frontend/playwright-report/
          retention-days: 7
          if-no-files-found: warn

      # ========== 9. ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šï¼ˆæ€»æ˜¯ï¼‰==========
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-report-${{ github.run_id }}
          path: frontend/playwright-report/
          retention-days: 3

      # ========== 10. æ¸…ç†æœåŠ¡ ==========
      - name: Cleanup services
        if: always()
        run: |
          echo "Stopping services..."
          kill $BACKEND_PID 2>/dev/null || true
          kill $FRONTEND_PID 2>/dev/null || true
          echo "Cleanup complete"

      # ========== 11. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Šæ‘˜è¦ ==========
      - name: Generate Job Summary
        if: always()
        run: |
          echo "### ğŸš€ E2E Nightly Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Artifacts** section for \`evidence.json\` and Playwright reports." >> $GITHUB_STEP_SUMMARY

  # ========== æµ‹è¯•ç»“æœé€šçŸ¥ ==========
  notify:
    name: Notify test results
    needs: e2e-test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test result
        run: |
          if [ "${{ needs.e2e-test.result }}" == "success" ]; then
            echo "âœ… E2E tests passed"
          else
            echo "âŒ E2E tests failed"
            # è¿™é‡Œå¯ä»¥æ·»åŠ  Slack/Email é€šçŸ¥
            # curl -X POST $SLACK_WEBHOOK -d '{"text":"E2E tests failed: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
          fi
